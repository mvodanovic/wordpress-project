version: '2.4'
services:
    database:
        image: mysql:5.7.31
        container_name: database
        restart: always
        ports:
            - "23306:3306"
        expose:
            - 3306
        environment:
            MYSQL_ROOT_PASSWORD: ${ROOT_PASSWORD}
            MYSQL_DATABASE: frozen_spring
            MYSQL_USER: frozensp
            MYSQL_PASSWORD: ${USER_PASSWORD}
        volumes:
            - "./database:/var/lib/mysql/"
        healthcheck:
            test: ["CMD", "mysqladmin" ,"ping", "-h", "localhost", "-u", "root", "-p$$MYSQL_ROOT_PASSWORD"]
            timeout: 20s
            retries: 10

    frozen-spring:
        image: frozen-spring:latest
        build: build/wordpress
        container_name: frozen-spring
        restart: always
        ports:
            - "20443:443"
        environment:
            WORDPRESS_DB_HOST: database
            WORDPRESS_DB_USER: frozensp
            WORDPRESS_DB_PASSWORD: ${USER_PASSWORD}
            WORDPRESS_DB_NAME: frozen_spring
            WORDPRESS_CONFIG_EXTRA: |
                define('AUTOMATIC_UPDATER_DISABLED', true);
        volumes:
            - "./themes:/var/www/html/wp-content/themes/"
            - "./plugins:/var/www/html/wp-content/plugins"
            - "./uploads:/var/www/html/wp-content/uploads"
            - "./ssl:/var/www/ssl"
            - "./logs:/var/www/logs"
            - "./apache2/wordpress-in-docker.000-default.conf:/etc/apache2/sites-available/000-default.conf"
        depends_on:
            database:
                condition: service_healthy

    phpmyadmin:
        image: phpmyadmin/phpmyadmin
        container_name: phpmyadmin
        restart: always
        ports:
            - "20080:80"
        environment:
            PMA_HOST: database
            PMA_PORT: 3306
            PMA_USER: frozensp
            PMA_PASSWORD: ${USER_PASSWORD}
        volumes:
            - "./ssl:/var/www/ssl"
            - "./logs:/var/www/logs"
            - "./apache2/phpmyadmin-in-docker.000-default.conf:/etc/apache2/sites-available/000-default.conf"
        depends_on:
            database:
                condition: service_healthy
